<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu số đăng ký thuốc</title>
    <style>
        :root {
            --primary-color: #44b1c1;
            --primary-hover: #3a9aa9;
            --light-bg: #f8f9fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            min-height: 100vh;
            line-height: 1.5;
        }
        
        .container {
            min-height: 100vh;
            width: 100%;
        }
        
        /* Header Section */
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 2px solid #e2e8f0;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .title {
            text-align: center;
            color: var(--primary-color);
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
            letter-spacing: -0.3px;
        }

        /* Search Section */
        .search-section {
            background: white;
            padding: 20px; /* reduced padding from 32px to 20px */
            margin: 16px; /* reduced margin from 24px to 16px */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition); /* added transition for smooth toggle */
        }

        .search-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .search-title {
            color: var(--primary-color);
            margin-bottom: 16px; /* reduced margin from 24px to 16px */
            font-size: 18px; /* reduced font size from 20px to 18px */
            text-align: center;
            font-weight: 500;
        }

        /* Added toggle button styles */
        .toggle-search-btn {
            position: fixed;
            top: 50px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            z-index: 1000;
            display: none; /* Hidden initially, shown after search */
        }

        .toggle-search-btn:hover {
            background-color: var(--primary-hover);
            transform: scale(1.1);
        }
        
        /* Chat popup styles */
        .chat-popup {
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 13px;
            color: #2d3748;
            white-space: nowrap;
            z-index: 1001;
            opacity: 1;
            visibility: visible;
            transition: all 0.3s ease;
            max-width: 300px; /* increased from 280px to 300px to fully prevent text cutoff */
            margin-right: 8px;
        }
        
        .chat-popup::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-left-color: white;
        }
        
        .chat-popup::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            border: 7px solid transparent;
            border-left-color: #e2e8f0;
        }

        .search-collapsed {
            display: none !important;
        }


        .search-box {
            position: relative;
            margin-bottom: 16px; /* reduced margin from 20px to 16px */
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px; /* reduced padding */
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 14px; /* reduced font size from 16px to 14px */
            transition: var(--transition);
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(68, 177, 193, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .search-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px; /* reduced gap from 16px to 12px */
            margin-bottom: 16px; /* reduced margin from 24px to 16px */
        }

        /* Added advanced filters section */
        .advanced-filters {
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
            margin-top: 16px;
        }

        .advanced-filters-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-toggle-icon {
            transition: transform 0.3s ease;
        }

        .filter-toggle-icon.expanded {
            transform: rotate(90deg);
        }

        .filters-content {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .filters-content.expanded {
            display: grid;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-group label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .option-group select {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 2px solid #e0e0e0;
            outline: none;
            transition: var(--transition);
        }

        .option-group select:focus {
            border-color: var(--primary-color);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }


        /* Progress Section */
        .progress-section {
            display: none;
            background: white;
            padding: 24px;
            margin: 0 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .progress-bar {
            background-color: #e0e0e0;
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .countdown-text {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        #countdown {
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Results Section */
        .results-section {
            background: white;
            margin: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: none;
        }

        /* Added result filter section styles */
        .result-filters {
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            background-color: #f8f9fa;
            display: none;
        }

        .result-filters.show {
            display: block;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .btn-filter {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-filter.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-filter.secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-filter:hover {
            opacity: 0.8;
        }

        /* Added cache notification styles */
        .cache-notification {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
            padding: 12px 16px;
            margin: 16px 24px;
            border-radius: var(--border-radius);
            font-size: 14px;
            display: none;
        }

        .cache-notification.show {
            display: block;
        }

        .results-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .results-count {
            font-size: 14px;
            color: #666;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 500;
            white-space: nowrap;
            border: 1px solid #ddd;
        }

        .data-table td {
            padding: 12px 8px;
            border: 1px solid #ddd;
            vertical-align: middle;
            text-align: center;
        }

        .data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .data-table tr:hover {
            background-color: #e8f4f8;
        }

        .text-wrap {
            max-width: 200px;
            word-wrap: break-word;
            white-space: normal;
        }

        .text-center {
            text-align: center;
        }

        /* Control Panel Styles (copied from index.html) */
        .control-panel {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 2px solid #e2e8f0;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .left-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .right-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .stats-display {
            display: flex;
            gap: 16px;
            align-items: center;
            font-size: 14px;
            color: #2d3748;
        }
        
        .stat-badge {
            background: #e6f3ff;
            color: #2b6cb0;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            border: 1px solid #bee3f8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Export section buttons - smaller size */
        .control-panel .btn {
            padding: 8px 16px;
            font-size: 13px;
            display: inline-flex;
            width: auto;
            min-width: 120px;
            text-transform: none;
            letter-spacing: 0.3px;
        }
        
        .btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(68, 177, 193, 0.2);
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary {
            background: #3182ce;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2c5aa0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(49, 130, 206, 0.3);
        }
        
        .btn-outline {
            background: white;
            color: #3182ce;
            border: 1px solid #3182ce;
        }
        
        .btn-outline:hover {
            background: #ebf8ff;
            border-color: #2c5aa0;
        }
        
        .font-weight-bold {
            font-weight: 600 !important;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            margin: 0 8px;
            transition: var(--transition);
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Loading Animation */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(68, 177, 193, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(68, 177, 193, 0); }
            100% { box-shadow: 0 0 0 0 rgba(68, 177, 193, 0); }
        }

        .btn-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .search-section {
                margin: 16px;
                padding: 20px;
            }

            .search-options {
                grid-template-columns: 1fr;
            }

            .results-section {
                margin: 16px;
            }

            .results-header {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .title {
                font-size: 24px;
            }
        }

        .auto-hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav style="background-color: var(--primary-color); padding: 8px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: white; font-weight: 600; font-size: 16px;">Tra cứu số đăng ký thuốc</div>
            <a href="https://tvtienanh.github.io/apiresearch/" target="_blank" style="color: white; text-decoration: none; padding: 6px 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; font-size: 14px; transition: all 0.3s ease;">
                Tra cứu nguồn
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <h1 class="title">Tra cứu số đăng ký thuốc</h1>
        </header>

        <!-- Added toggle button for search section -->
        <button class="toggle-search-btn" id="toggleSearchBtn" onclick="toggleSearchSection()" title="Hiện/Ẩn tìm kiếm">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <div class="chat-popup">
                Tra cứu thêm số đăng ký tại đây
            </div>
        </button>

        <!-- Search Section -->
        <div class="search-section" id="searchSection">
            <div class="search-container">
                <h3 class="search-title">Tìm kiếm thông tin thuốc</h3>
                
                <div class="search-box">
                    <div class="search-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                    <input type="text" id="searchText" class="search-input" placeholder="Nhập từ khóa tìm kiếm (tên thuốc, số đăng ký, hoạt chất...)">
                </div>
                
                <div class="search-options">
                    <div class="option-group">
                        <label for="resultLimit">Giới hạn kết quả:</label>
                        <select id="resultLimit">
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                            <option value="1500">1500</option>
                            <option value="2000">2000</option>
                            <option value="2500">2500</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="domesticOnly">
                        <label for="domesticOnly">Chỉ thuốc trong nước</label>
                    </div>
                </div>

                <!-- Removed advanced filters from search section -->
                
                <button id="searchBtn" onclick="searchDrugs()" class="btn">Tìm kiếm</button>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <div class="progress-text" id="progressText">Đang tìm kiếm...</div>
            <div class="progress-bar">
                <div id="progress" class="progress"></div>
            </div>
            <div class="countdown-text">Thời gian còn lại: <span id="countdown">đang tính toán</span></div>
        </div>

        <!-- Added cache notification -->
        <div class="cache-notification" id="cacheNotification">
            <strong>📋 Dữ liệu từ bộ nhớ đệm:</strong> Đây là kết quả đã tìm kiếm trước đó cho từ khóa này.
        </div>

        <!-- Control Panel (only shown when there are results) -->
        <div class="control-panel" id="controlPanel" style="display: none;">
            <div class="left-controls">
                <div class="stats-display">
                    <div class="stat-badge">
                        Kết quả tìm thấy: <span id="resultsCount" class="font-weight-bold">0</span>
                    </div>
                </div>
            </div>
            
            <div class="right-controls">
                <button class="btn btn-outline" onclick="toggleFilterSection()">
                    <span id="filterToggleText">Ẩn bộ lọc</span>
                </button>
                <button class="btn btn-outline" onclick="clearResults()">
                    Xóa kết quả
                </button>
                <button class="btn btn-primary" onclick="exportToExcel()">
                    Xuất Excel
                </button>
                <button class="btn btn-outline" onclick="exportToJSON()">
                    Xuất JSON
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Added result filters section -->
            <div class="result-filters" id="resultFilters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterDrugName">Tên thuốc</label>
                        <input type="text" id="filterDrugName" placeholder="Lọc theo tên thuốc">
                    </div>
                    <div class="filter-group">
                        <label for="filterRegistrationNumber">Số đăng ký</label>
                        <input type="text" id="filterRegistrationNumber" placeholder="Lọc theo số đăng ký">
                    </div>
                    <div class="filter-group">
                        <label for="filterActiveIngredient">Hoạt chất</label>
                        <input type="text" id="filterActiveIngredient" placeholder="Lọc theo hoạt chất">
                    </div>
                    <div class="filter-group">
                        <label for="filterManufacturingCountry">Nước sản xuất</label>
                        <select id="filterManufacturingCountry">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterDosageForm">Dạng bào chế</label>
                        <select id="filterDosageForm">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterRegistrationCountry">Nước đăng ký</label>
                        <select id="filterRegistrationCountry">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterCompany">Công ty</label>
                        <input type="text" id="filterCompany" placeholder="Lọc theo công ty">
                    </div>
                    <div class="filter-group">
                        <label for="filterExpired">Tình trạng</label>
                        <select id="filterExpired">
                            <option value="">Tất cả</option>
                            <option value="valid">Còn hạn</option>
                            <option value="expired">Hết hạn</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter secondary" onclick="clearFilters()">Xóa bộ lọc</button>
                </div>
            </div>

            <div class="results-header">
                <div class="results-title">Kết quả tìm kiếm</div>
                <div class="results-count" id="resultsCount">0 kết quả</div>
            </div>
            
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Số đăng ký</th>
                            <th>Tên thuốc</th>
                            <th>Ngày hết hạn</th>
                            <th>Hoạt chất</th>
                            <th>Hàm lượng</th>
                            <th>Dạng bào chế</th>
                            <th>Quy cách đóng gói</th>
                            <th>Công ty đăng ký</th>
                            <th>Nước đăng ký</th>
                            <th>Công ty sản xuất</th>
                            <th>Nước sản xuất</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let searchResults = [];
        let filteredResults = [];
        let searchCache = {};

        // Format date function
        function formatDate(dateString) {
            if (!dateString) return "";
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            } catch (e) {
                return "";
            }
        }

        // Add focus and pulse effect
        document.getElementById('searchText').addEventListener('focus', function() {
            document.getElementById('searchBtn').classList.add('btn-pulse');
        });

        document.getElementById('searchText').addEventListener('blur', function() {
            document.getElementById('searchBtn').classList.remove('btn-pulse');
        });

        // Add Enter key listener
        document.getElementById('searchText').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchDrugs();
            }
        });

        function toggleSearchSection() {
            const searchSection = document.getElementById('searchSection');
            const toggleBtn = document.getElementById('toggleSearchBtn');
            
            const isHidden = searchSection.classList.contains('search-collapsed') || 
                            searchSection.classList.contains('auto-hidden');
            
            if (isHidden) {
                searchSection.classList.remove('search-collapsed', 'auto-hidden');
                toggleBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    <div class="chat-popup">
                        Tra cứu thêm số đăng ký tại đây
                    </div>
                `;
                toggleBtn.title = "Ẩn tìm kiếm";
            } else {
                searchSection.classList.add('search-collapsed');
                toggleBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <div class="chat-popup">
                        Tra cứu thêm số đăng ký tại đây
                    </div>
                `;
                toggleBtn.title = "Hiện tìm kiếm";
            }
        }


        function toggleAdvancedFilters() {
            const filtersContent = document.getElementById('filtersContent');
            const toggleIcon = document.getElementById('filterToggleIcon');
            
            if (filtersContent.classList.contains('expanded')) {
                filtersContent.classList.remove('expanded');
                toggleIcon.classList.remove('expanded');
                toggleIcon.textContent = '▶';
            } else {
                filtersContent.classList.add('expanded');
                toggleIcon.classList.add('expanded');
                toggleIcon.textContent = '▼';
            }
        }

        async function searchDrugs() {
            const searchText = document.getElementById('searchText').value.trim();
            const resultLimit = parseInt(document.getElementById('resultLimit').value);
            const domesticOnly = document.getElementById('domesticOnly').checked;

            if (!searchText) {
                // Shake animation for empty input
                const searchInput = document.getElementById('searchText');
                searchInput.style.borderColor = '#ff4d4d';
                searchInput.style.animation = 'shake 0.5s';
                setTimeout(function() {
                    searchInput.style.borderColor = '#e0e0e0';
                    searchInput.style.animation = '';
                }, 500);
                return;
            }

            const cacheKey = `${searchText}_${resultLimit}_${domesticOnly}`;
            if (searchCache[cacheKey]) {
                displayCachedResults(cacheKey);
                return;
            }

            // Reset processing status
            const isProcessingComplete = false;

            // Show progress section
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.textContent = 'Đang tìm kiếm...';

            const progress = document.getElementById('progress');
            const progressText = document.getElementById('progressText');
            const countdownElement = document.getElementById('countdown');

            // Show calculating status
            progressText.textContent = 'Đang kết nối với cơ sở dữ liệu...';
            countdownElement.textContent = 'đang tính toán';

            // Start progress animation
            let width = 0;
            const progressInterval = setInterval(function() {
                if (width >= 90) {
                    clearInterval(progressInterval);
                } else {
                    width += 3;
                    progress.style.width = width + '%';
                }
            }, 100);

            try {
                // Prepare API payload
                const payload = {
                    filterText: searchText,
                    SoDangKyThuoc: {},
                    KichHoat: true,
                    skipCount: 0,
                    maxResultCount: resultLimit,
                    sorting: null
                };

                // Add filters to payload
                if (domesticOnly) {
                    payload.SoDangKyThuoc.phanLoaiThuocEnum = "1";
                }

                // Make API call
                const response = await fetch('https://dichvucong.dav.gov.vn/api/services/app/soDangKy/GetAllPublicServerPaging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();

                // Complete progress
                clearInterval(progressInterval);
                progress.style.width = '100%';
                progressText.textContent = 'Đã hoàn thành! Đang xử lý dữ liệu...';

                // Process results
                if (!responseData.result || !responseData.result.items || responseData.result.items.length === 0) {
                    displayNoResults();
                    return;
                }

                searchResults = responseData.result.items;
                const totalResults = responseData.result.totalCount;
                const displayedResults = Math.min(searchResults.length, resultLimit);

                searchCache[cacheKey] = {
                    results: searchResults,
                    totalResults: totalResults,
                    displayedResults: displayedResults,
                    timestamp: new Date().getTime()
                };

                // Calculate processing time (simulate)
                const processingTime = Math.ceil(displayedResults * 0.01);
                
                if (processingTime <= 0) {
                    displayResults(searchResults, totalResults);
                    return;
                }

                // Start countdown
                let countdownTime = processingTime;
                countdownElement.textContent = countdownTime + ' giây';

                const countdownInterval = setInterval(function() {
                    countdownTime--;
                    countdownElement.textContent = countdownTime + ' giây';

                    if (countdownTime <= 0) {
                        clearInterval(countdownInterval);
                        displayResults(searchResults, totalResults);
                    }
                }, 1000);

            } catch (error) {
                clearInterval(progressInterval);
                
                // Show specific error message for CORS
                let errorMessage = error.message;
                if (error.message.includes('CORS') || error.message.includes('blocked') || error.message.includes('Access-Control-Allow-Origin')) {
                    errorMessage = 'Lỗi CORS: Không thể kết nối đến server. Vui lòng thử lại hoặc kiểm tra kết nối mạng.';
                }
                
                progressText.textContent = 'Lỗi: ' + errorMessage;
                progress.style.backgroundColor = '#ff4d4d';
                countdownElement.textContent = 'Lỗi';
                
                // Re-enable search button after error
                setTimeout(function() {
                    document.getElementById('progressSection').style.display = 'none';
                }, 3000);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Tìm kiếm';
            }
        }

        function displayCachedResults(cacheKey) {
            const cached = searchCache[cacheKey];
            searchResults = cached.results;
            filteredResults = [...searchResults];
            
            document.getElementById('cacheNotification').classList.add('show');
            document.getElementById('controlPanel').style.display = 'flex'; // Show control panel for cached results
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultFilters').classList.add('show');
            
            const searchSection = document.getElementById('searchSection');
            const toggleBtn = document.getElementById('toggleSearchBtn');
            
            searchSection.classList.add('auto-hidden');
            toggleBtn.style.display = 'block';
            toggleBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <div class="chat-popup">
                    Tra cứu thêm số đăng ký tại đây
                </div>
            `;
            toggleBtn.title = "Hiện tìm kiếm";
            
            populateFilterOptions();
            displayFilteredResults(cached.totalResults, cached.displayedResults);
            
            // Hide cache notification after 3 seconds
            setTimeout(() => {
                document.getElementById('cacheNotification').classList.remove('show');
            }, 3000);
        }

        function displayNoResults() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('controlPanel').style.display = 'none'; // Hide control panel when no results
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsCount').textContent = '0 kết quả';
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="12" class="text-center">Không tìm thấy kết quả</td></tr>';
            
            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = false;
            searchBtn.textContent = 'Tìm kiếm';
        }

        function displayResults(data, totalOriginal, fromCache = false) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('cacheNotification').classList.remove('show'); // Hide cache notification
            document.getElementById('controlPanel').style.display = 'flex'; // Show control panel when there are results
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultFilters').classList.add('show'); // Show result filters
            
            const searchSection = document.getElementById('searchSection');
            const toggleBtn = document.getElementById('toggleSearchBtn');
            
            searchSection.classList.add('auto-hidden');
            toggleBtn.style.display = 'block';
            toggleBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <div class="chat-popup">
                    Tra cứu thêm số đăng ký tại đây
                </div>
            `;
            toggleBtn.title = "Hiện tìm kiếm";

            filteredResults = [...data];
            document.getElementById('resultsCount').textContent = `${filteredResults.length} kết quả (Tổng gốc: ${totalOriginal})`;
            // Update control panel count
            const controlPanelCount = document.querySelector('#controlPanel .stat-badge .font-weight-bold');
            if (controlPanelCount) {
                controlPanelCount.textContent = filteredResults.length;
            }
            
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            if (filteredResults.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="12" class="text-center">Không có kết quả phù hợp với bộ lọc</td></tr>';
                return;
            }

            filteredResults.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Process registration number
                let soDangKyText = item.soDangKy || "";
                if (item.soDangKyCu && item.soDangKyCu !== item.soDangKy && item.soDangKyCu !== "") {
                    soDangKyText += `\n(SĐK cũ: ${item.soDangKyCu})`;
                }

                // Process dates
                let ngayHetHanSoDangKy = "";
                if (item.thongTinDangKyThuoc && item.thongTinDangKyThuoc.ngayHetHanSoDangKy) {
                    ngayHetHanSoDangKy = formatDate(item.thongTinDangKyThuoc.ngayHetHanSoDangKy);
                }

                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td class="text-center">${soDangKyText}</td>
                    <td class="text-wrap">${(item.tenThuoc || "").trim()}</td>
                    <td class="text-center">${ngayHetHanSoDangKy}</td>
                    <td class="text-wrap">${((item.thongTinThuocCoBan && item.thongTinThuocCoBan.hoatChatChinh) || "").trim()}</td>
                    <td class="text-wrap">${((item.thongTinThuocCoBan && item.thongTinThuocCoBan.hamLuong) || "").trim()}</td>
                    <td class="text-wrap">${((item.thongTinThuocCoBan && item.thongTinThuocCoBan.dangBaoChe) || "").trim()}</td>
                    <td class="text-wrap">${((item.thongTinThuocCoBan && item.thongTinThuocCoBan.dongGoi) || "").trim()}</td>
                    <td class="text-wrap">${((item.congTyDangKy && item.congTyDangKy.tenCongTyDangKy) || "").trim()}</td>
                    <td class="text-center">${((item.congTyDangKy && item.congTyDangKy.nuocDangKy) || "").trim()}</td>
                    <td class="text-wrap">${((item.congTySanXuat && item.congTySanXuat.tenCongTySanXuat) || "").trim()}</td>
                    <td class="text-center">${((item.congTySanXuat && item.congTySanXuat.nuocSanXuat) || "").trim()}</td>
                `;
                
                if (index === 0) {
                    console.log("[v0] Sample item structure:", item);
                    console.log("[v0] Company registration data:", item.congTyDangKy);
                    console.log("[v0] Company manufacturing data:", item.congTySanXuat);
                }

                tableBody.appendChild(row);
            });

            setupFilterListeners();
        }

        function applyFilters() {
            const drugName = document.getElementById('filterDrugName').value.toLowerCase();
            const registrationNumber = document.getElementById('filterRegistrationNumber').value.toLowerCase();
            const activeIngredient = document.getElementById('filterActiveIngredient').value.toLowerCase();
            const manufacturingCountry = document.getElementById('filterManufacturingCountry').value;
            const dosageForm = document.getElementById('filterDosageForm').value;
            const registrationCountry = document.getElementById('filterRegistrationCountry').value;
            const company = document.getElementById('filterCompany').value.toLowerCase();
            const expiredFilter = document.getElementById('filterExpired').value;

            filteredResults = searchResults.filter(item => {
                // Filter by drug name
                if (drugName && !(item.tenThuoc || "").toLowerCase().includes(drugName)) {
                    return false;
                }

                // Filter by registration number
                if (registrationNumber && !(item.soDangKy || "").toLowerCase().includes(registrationNumber)) {
                    return false;
                }

                // Filter by active ingredient
                if (activeIngredient && !((item.thongTinThuocCoBan?.hoatChatChinh) || "").toLowerCase().includes(activeIngredient)) {
                    return false;
                }

                // Filter by manufacturing country
                if (manufacturingCountry && (item.congTySanXuat?.nuocSanXuat) !== manufacturingCountry) {
                    return false;
                }

                // Filter by dosage form
                if (dosageForm && (item.thongTinThuocCoBan?.dangBaoChe) !== dosageForm) {
                    return false;
                }

                // Filter by registration country
                if (registrationCountry && (item.congTyDangKy?.nuocDangKy) !== registrationCountry) {
                    return false;
                }

                // Filter by company
                if (company) {
                    const registrationCompany = (item.congTyDangKy?.tenCongTyDangKy || "").toLowerCase();
                    const manufacturingCompany = (item.congTySanXuat?.tenCongTySanXuat || "").toLowerCase();
                    if (!registrationCompany.includes(company) && !manufacturingCompany.includes(company)) {
                        return false;
                    }
                }

                // Filter by expiration status
                if (expiredFilter) {
                    const expiryDate = item.thongTinDangKyThuoc?.ngayHetHanSoDangKy;
                    if (expiryDate) {
                        const isExpired = new Date(expiryDate) < new Date();
                        if (expiredFilter === 'valid' && isExpired) return false;
                        if (expiredFilter === 'expired' && !isExpired) return false;
                    }
                }

                return true;
            });

            displayResults(filteredResults, searchResults.length);
        }

        function clearFilters() {
            document.getElementById('filterDrugName').value = '';
            document.getElementById('filterRegistrationNumber').value = '';
            document.getElementById('filterActiveIngredient').value = '';
            document.getElementById('filterManufacturingCountry').value = '';
            document.getElementById('filterDosageForm').value = '';
            document.getElementById('filterRegistrationCountry').value = '';
            document.getElementById('filterCompany').value = '';
            document.getElementById('filterExpired').value = '';

            filteredResults = [...searchResults];
            displayResults(filteredResults, searchResults.length);
        }

        function exportToExcel() {
            if (filteredResults.length === 0) {
                alert('Không có dữ liệu để xuất');
                return;
            }

            const headers = ['STT', 'Số đăng ký', 'Tên thuốc', 'Ngày hết hạn', 'Hoạt chất', 'Hàm lượng', 'Dạng bào chế', 'Quy cách đóng gói', 'Công ty đăng ký', 'Nước đăng ký', 'Công ty sản xuất', 'Nước sản xuất'];
            
            const data = [headers];
            
            filteredResults.forEach((item, index) => {
                const row = [
                    index + 1,
                    item.soDangKy || "",
                    item.tenThuoc || "",
                    formatDate(item.thongTinDangKyThuoc?.ngayHetHanSoDangKy),
                    (item.thongTinThuocCoBan?.hoatChatChinh) || "",
                    (item.thongTinThuocCoBan?.hamLuong) || "",
                    (item.thongTinThuocCoBan?.dangBaoChe) || "",
                    (item.thongTinThuocCoBan?.dongGoi) || "",
                    (item.congTyDangKy?.tenCongTyDangKy) || "",
                    (item.congTyDangKy?.nuocDangKy) || "",
                    (item.congTySanXuat?.tenCongTySanXuat) || "",
                    (item.congTySanXuat?.nuocSanXuat) || ""
                ];
                data.push(row);
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            const colWidths = [
                { wch: 5 },   // STT
                { wch: 15 },  // Số đăng ký
                { wch: 30 },  // Tên thuốc
                { wch: 12 },  // Ngày hết hạn
                { wch: 25 },  // Hoạt chất
                { wch: 15 },  // Hàm lượng
                { wch: 15 },  // Dạng bào chế
                { wch: 20 },  // Quy cách đóng gói
                { wch: 25 },  // Công ty đăng ký
                { wch: 15 },  // Nước đăng ký
                { wch: 25 },  // Công ty sản xuất
                { wch: 15 }   // Nước sản xuất
            ];
            ws['!cols'] = colWidths;

            // Style header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F46E5" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };

            // Apply header styling
            for (let col = 0; col < headers.length; col++) {
                const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellRef]) ws[cellRef] = {};
                ws[cellRef].s = headerStyle;
            }

            // Style data rows
            const dataStyle = {
                alignment: { vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "E5E7EB" } },
                    bottom: { style: "thin", color: { rgb: "E5E7EB" } },
                    left: { style: "thin", color: { rgb: "E5E7EB" } },
                    right: { style: "thin", color: { rgb: "E5E7EB" } }
                }
            };

            // Apply data row styling
            for (let row = 1; row < data.length; row++) {
                for (let col = 0; col < headers.length; col++) {
                    const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
                    if (!ws[cellRef]) ws[cellRef] = {};
                    
                    // Alternate row colors
                    const rowStyle = { ...dataStyle };
                    if (row % 2 === 0) {
                        rowStyle.fill = { fgColor: { rgb: "F9FAFB" } };
                    }
                    
                    // Center align STT column
                    if (col === 0) {
                        rowStyle.alignment = { horizontal: "center", vertical: "center" };
                    }
                    
                    ws[cellRef].s = rowStyle;
                }
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Kết quả tra cứu thuốc");

            // Export file
            const fileName = `ket-qua-tra-cuu-thuoc-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function exportToJSON() {
            if (filteredResults.length === 0) {
                alert('Không có dữ liệu để xuất');
                return;
            }

            const blob = new Blob([JSON.stringify(filteredResults, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ket-qua-tra-cuu-thuoc-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function toggleFilterSection() {
            const filterSection = document.getElementById('resultFilters');
            const toggleText = document.getElementById('filterToggleText');
            
            if (filterSection.classList.contains('show')) {
                filterSection.classList.remove('show');
                toggleText.textContent = 'Hiện bộ lọc';
            } else {
                filterSection.classList.add('show');
                toggleText.textContent = 'Ẩn bộ lọc';
            }
        }

        function clearResults() {
            searchResults = [];
            filteredResults = []; // Clear filtered results
            searchCache = {}; // Clear cache
            document.getElementById('controlPanel').style.display = 'none'; // Hide control panel when clearing results
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('resultFilters').classList.remove('show'); // Hide result filters
            document.getElementById('cacheNotification').classList.remove('show'); // Hide cache notification
            document.getElementById('toggleSearchBtn').style.display = 'none';
            
            const searchSection = document.getElementById('searchSection');
            searchSection.classList.remove('search-collapsed', 'auto-hidden');
            
            document.getElementById('searchText').value = '';
            document.getElementById('domesticOnly').checked = false;
            document.getElementById('resultLimit').value = '500';
        }

        function setupFilterListeners() {
            const filterInputs = [
                'filterDrugName',
                'filterRegistrationNumber', 
                'filterActiveIngredient',
                'filterManufacturingCountry',
                'filterDosageForm',
                'filterRegistrationCountry',
                'filterCompany',
                'filterExpired'
            ];

            filterInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', applyFilters);
                    element.addEventListener('change', applyFilters);
                }
            });
        }

        function populateFilterOptions() {
            const countries = [...new Set(searchResults.map(item => item.congTySanXuat?.nuocSanXuat).filter(Boolean))].sort();
            const dosageForms = [...new Set(searchResults.map(item => item.thongTinThuocCoBan?.dangBaoChe).filter(Boolean))].sort();
            const registrationCountries = [...new Set(searchResults.map(item => item.congTyDangKy?.nuocDangKy).filter(Boolean))].sort();

            populateSelect('filterManufacturingCountry', countries);
            populateSelect('filterDosageForm', dosageForms);
            populateSelect('filterRegistrationCountry', registrationCountries);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Clear existing options except first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            select.value = currentValue;
        }
    </script>
</body>
</html>
